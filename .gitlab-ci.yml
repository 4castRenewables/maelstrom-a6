include:
  - project: "mq/ci-templates"
    file: "/templates/python/ci.yml"

workflow:
  rules:
    - if: "$CI_MERGE_REQUEST_ID"
    - if: "$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH"

variables:
  POETRY_IMAGE_VERSION: "3.9-1.1.13"
  PY_PACKAGE: "./src"
  PY_PYTEST_DIR: "./src/tests"
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/pip-cache"


stages:
 - lint
 - test

.image: &image
  image:
      name: mquade/poetry:$POETRY_IMAGE_VERSION
      entrypoint: [""]

black:
  <<: *image
  extends: .lint-black

flake8:
  <<: *image
  extends: .lint-flake8

reorder-imports:
  <<: *image
  cache:
    key: "pip"
    paths:
      - $PIP_CACHE_DIR
  stage: lint
  script:
    - pip install reorder-python-imports
    - reorder-python-imports --application-directories=.:src
  rules:
    - changes:
        - '**/*.py'


test:
  <<: *image
  extends: .test
  before_script:
    - export PYTHONPATH=$PYTHONPATH:src
    - apt update -y && apt upgrade -y
    # Install gcc, required for HDBSCAN.
    - apt install -y build-essential




