include:
  - project: 4cast1/ci-templates
    ref: fix-zipped-docker-image-name
    file: /python/default-lint.yml
  - project: 4cast1/ci-templates
    ref: fix-zipped-docker-image-name
    file: /python/templates.yml
  - project: 4cast1/ci-templates
    ref: fix-zipped-docker-image-name
    file: /docker/templates.yml

variables:
  POETRY_IMAGE_VERSION: 3.9-1.2.1
  PY_SRC: src/a6
  PY_LINT_DIRS: src/a6 src/tests scripts mlflow
  PY_PYUPGRADE_ARGS: |
    --py3-plus
    --py36-plus
    --py37-plus
    --py38-plus
    --py39-plus
  DOCKER_FILE: mlflow/Dockerfile
  DOCKER_IMAGE_NAME: a6-mlflow
  DOCKER_ZIPPED_IMAGE_FILE: a6-mlflow

stages:
 - lint
 - test
 - validate
 - build
 - integration

mypy:
  extends: .lint-mypy
  allow_failure: true

pylint:
  extends: .lint-pylint
  allow_failure: true

.test-base:
  extends: .test
  needs: []
  before_script:
    - export PYTHONPATH=$PYTHONPATH:src
    - apt update -y && apt upgrade -y
    # Install gcc, required for HDBSCAN.
    - apt install -y build-essential

test-doc:
  extends: .test-base
  variables:
    PY_PYTEST_DIR: src/a6

test-unit:
  extends: .test-base
  variables:
    PY_PYTEST_DIR: src/tests


coverage:
  extends: .coverage
  needs:
    - job: test-unit
      artifacts: true

build-python:
  needs: []
  extends: .build-python
  script:
    - !reference [.build-python, script]
    - python -m venv venv
    - source venv/bin/activate
    - pip install --upgrade pip
    - pip install dist/*.whl
    # HDBSCAN import fails for joblib>1.1.0
    - pip install joblib==1.1.0
  artifacts:
    when: always
    paths:
      - .cache/pip
      - dist/
      - venv/

build-docker:
  extends: .build-docker
  needs:
    - job: build-python
      artifacts: true

.test-integration:
  stage: integration
  needs:
    - job: build-python
      artifacts: true
    - job: build-docker
      artifacts: true
  services:
    - docker:dind
  image: docker:latest
  variables:
  before_script:
    - !reference [.set-required-docker-environment-variables, script]
    - ls -al .
    - docker load -i ${DOCKER_ZIPPED_IMAGE_FILE}.tar.gz
    - docker tag ${IMAGE_NAME}:latest ${DOCKER_IMAGE_NAME}:latest
    # Install Python 3
    - apk update
    - apk --no-cache add python3
    # Add link to Python3 at /usr/bin/python
    - ln -sf python3 /usr/bin/python
    # Relink python executable in venv to /usr/bin/python
    - ln -sf /usr/bin/python ${PWD}/venv/bin/python
    # Set PATH and PYTHONPATH to include venv
    - export PATH=${PWD}/venv/bin:$PATH
    - export PYTHONPATH=$PYTHONPATH:${PWD}/venv/lib/python3.9/site-packages
    - alias mlflow="${PWD}/venv/bin/python ${PWD}/venv/bin/mlflow"

test-cluster:
  extends: .test-integration
  script:
    - >
      mlflow
      run mlflow
      -e cluster
      -P weather_data=/data/temperature_level_128_daily_averages_2020.nc
      -P config=cluster.yaml
      -P use_varimax=false
      -P log_to_mantik=false

test-temporal:
  extends: .test-integration
  script:
    - >
      mlflow
      run mlflow
      -e temporal
      -P weather_data=/data/temperature_level_128_daily_averages_2020.nc
      -P use_varimax=false
      -P log_to_mantik=false

test-grid-search:
  extends: .test-integration
  script:
    - >
      mlflow
      run mlflow
      -e grid-search
      -P weather_data=/data/model_level_133_jan_2020.nc
      -P turbine_data=/data/turbine.nc
      -P config=grid-search.yaml
      -P use_varimax=false
      -P log_to_mantik=false
